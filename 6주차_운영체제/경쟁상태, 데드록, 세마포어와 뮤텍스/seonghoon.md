# 경쟁상태 + 세마포어와 뮤텍스 + 데드락(+ 해결법) + starvation 문제

## 경쟁상태(Race Condition)란?

공유 자원에 대해 여러 프로세스가 동시에 접근을 시도할 때, 타이밍이나 순서 등이 결과값에 영향을 줄 수 있는 상태

## 임계 영역(Critical Section)이란?

여러 프로세스가 데이터를 공유하면서 수행될텐데, 각 프로세스에서 공유 자원에 접근하는 프로그램 코드 부분

### Deadlock : 두 개 이상의 프로세스가 서로의 작업이 끝나기만을 기다리고 있기 때문에 무한히 대기하는 것(동기화와 연관)

### Starvation : 프로세스가 cpu 자원의 할당의 우산순위에서 밀려 무한히 대기하는 것 (cpu 스케쥴링과 연관)

### 임계 영역 해결 조건

- 상호 배제(Mutual Exclusion): 어떤 프로세스가 임계 영역을 수행 중이면 다른 프로세스들은 그 임계 영역에 들어갈 수 없다.
- 한정 대기(Bounded Waiting): 어떤 프로세스도 임계 영역에 진입하지 못하여 무한 대기(infinite postpone)하지 않아야 한다.
- 진행의 융통성(Progress Flexibility) : 한 프로세스가 다른 프로세스의 진행을 방해해서는 안된다.

<상호 배제 문제>

```java
**PROCESS A**

while(lock==true);
lock=true;

<임계 영역>

lock=false;
```

```java
**PROCESS B**

while(lock==true);
lock=true;

<임계 영역>

lock=false
```

<한정 대기 문제>

```java
**PROCESS B**

lock1=true;
while(lock2==true);

<임계 영역>

lock1=false;
```

```java
**PROCESS B**

lock2=true;
while(lock1==true);

<임계 영역>

lock2=false;
```

<진행의 융통성 문제>

```java
**PROCESS A**

while(lock==2);

<임계 영역>

lock=1;
```

```java
**PROCESS B**

while(lock==1);

<임계 영역>

lock=2;
```

## 대안으로 나온 것들

- 하드웨어로 해결
    
    **검사와 지정을 한번에** 실행하도록 하드웨어를 설계
    
    ex) while(testandset(&lock)==true);
    
- 피터슨 안고리즘
- 데커 알고리즘

→ 자원에 대한 한계가 있으며, 알고리즘의 경우 복잡함

## 세마포어(Semaphore)란?

여러 프로세스들이 공유 가능한 자원의 수를 나타내는 방법

wait과 signal이라는 연산에 의해서만 접근이 가능하다.

- wait : 세마포어 수를 1 감소시킴, 0일 경우, lock
- signal : 세마포어 수를 1 증가시킴

### 세마포어 방식

**Busy-Wait 방식**

- 자원이 모두 사용중이라면 프로세스가 wait
- 자원을 다 사용하고 임계 영역에서 나온 프로세스는 signal 연산을 하기 전까지 busy waiting을 함

**Block-Wakeup 방식**

- 자원이 모두 사용중이라면 프로세스를 wait 큐에 추가시킴
- 자원을 다 사용하고 임계 영역에서 나올 때, 사용 가능한 자원의 수가 없다면, wait 큐에서 프로세스를 꺼내와 wakeup 시킴

**임계 영역의 길이가 짧은 경우에는 잦은 문맥 교환으로 인해 오버헤드가 증가하기 때문에 busy-wait 방식이 유리**

## 뮤텍스(Mutex)란?

상호배제를 뜻하며, binary semaphore와 같은 의미이다.

- 프로세스가 소유할 수 있는 key를 기반으로 하며, 이 key를 소유한 스레드/프로세스만이 공유자원에 접근할 수 있다.

### 세마포어와의 차이점

- 세마포어는 뮤텍스가 될 수 있지만 뮤텍스는 세마포어가 될 수 없다.
- 뮤텍스는 동기화 대상이 1개일 때 사용하고, 세마포어는 동기화 대상이 여러개일 때 사용한다.
- 뮤텍스는 자원을 소유할 수 있고 책임을 가지지만, 세마포어는 자원을 소유할 수 없다.
- 뮤텍스는 자원을 소유하고 있는 스레드만이 뮤텍스를 해제할 수 있지만 세마포어는 자원을 소유하지 않는 스레드가 세마포어를 해제할 수 있다.

## 모니터(Monitor)란?

공유 자원을 내부족으로 숨기고 공유 자원에 접근하기 위한 인터페이스만을 제공

- 프로시저가 호출되면 안전하게 공유 자원을 사용할 수 있다.
- 프로세스가 세마포어의 `signal` 메커니즘을 자동으로 처리, 편리하게 뮤텍스 개념을 사용할 수 있도록 제공된다.
- 자바와 C#에서 스레드를 동기화하는 방법으로 모니터가 사용된다.

### 참고

책:: 쉽게 배우는 운영체제 - 조성호